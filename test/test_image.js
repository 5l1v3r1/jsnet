const {assertClose} = require('./test');
const jsnet = require('../build/build');

function testPadImages() {
    const image = new jsnet.Tensor([2, 4, 2, 3], [0.510, -1.990, 0.680, -2.280, 0.910, 0.070, 0.800, -0.060, -0.540, 0.020, -1.990, 1.820, -0.050, 2.630, 1.630, 0.430, 1.050, 0.320, 0.790, -0.530, -0.350, -1.220, 0.060, -0.640, -1.300, 0.380, 0.380, 0.540, 0.130, -2.820, 0.340, -1.170, -0.360, 2.380, -1.760, -0.340, -0.240, 0.190, -0.170, -0.700, 0.910, -0.620, -0.970, -0.230, -0.330, 1.710, -1.470, -0.210]);
    const padded = new jsnet.Tensor([2, 7, 9, 3], [0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.510, -1.990, 0.680, -2.280, 0.910, 0.070, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.800, -0.060, -0.540, 0.020, -1.990, 1.820, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -0.050, 2.630, 1.630, 0.430, 1.050, 0.320, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.790, -0.530, -0.350, -1.220, 0.060, -0.640, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -1.300, 0.380, 0.380, 0.540, 0.130, -2.820, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.340, -1.170, -0.360, 2.380, -1.760, -0.340, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -0.240, 0.190, -0.170, -0.700, 0.910, -0.620, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, -0.970, -0.230, -0.330, 1.710, -1.470, -0.210, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000]);
    const upstream = new jsnet.Tensor([2, 7, 9, 3], [0.500, 0.060, -0.640, -0.180, -1.590, -0.240, 0.060, -0.250, -0.770, 1.680, -2.370, 0.020, 0.940, -0.090, 1.090, 2.750, -2.090, 0.760, 1.950, -0.420, -0.730, -1.060, 0.550, -0.090, 0.690, -0.620, 0.450, 2.800, -0.540, -1.580, 0.930, 0.450, 0.060, 0.410, -0.930, -1.520, -0.890, -0.580, -0.080, -0.040, -0.430, -0.960, 0.640, 0.020, -0.250, 0.460, 0.000, 0.760, -1.110, -0.470, 1.560, 0.110, -0.560, -1.460, -0.810, -1.160, 1.190, 0.740, -0.550, -0.840, -2.050, 1.410, 0.370, -0.190, 0.380, -0.340, 0.370, 0.590, -0.400, 0.740, -0.560, -1.430, 0.150, 2.260, -0.250, 0.340, 0.240, -0.390, -0.170, 0.080, 0.110, 1.670, 0.570, -0.170, 0.300, 0.700, -0.930, 1.080, -0.500, -1.690, 0.360, 1.000, 0.160, -0.390, 1.150, -0.680, 0.500, 0.210, 0.090, -1.880, -0.760, -1.550, 1.150, -1.030, 0.030, 1.920, 0.040, -0.530, -1.610, 0.390, 1.090, -0.820, -0.990, 2.980, 0.620, 0.720, -1.130, 0.450, 0.710, 1.560, 0.020, -0.180, -2.330, -0.010, -0.750, -0.970, 0.720, -0.220, -0.780, -2.450, -2.180, -1.160, 0.110, 0.680, -0.190, -0.020, -0.330, -1.050, -1.440, 0.510, -2.360, -0.370, 1.740, -0.350, -0.270, -2.100, 0.400, -1.580, 0.180, -1.940, 1.530, -0.680, -2.430, -0.140, -0.250, -0.970, -0.910, 0.050, 0.150, -0.540, 1.650, 0.150, -0.500, 0.190, -1.810, -0.510, -0.010, 0.710, -0.450, 0.950, -0.870, -0.300, -2.130, -0.190, 1.310, 0.580, -1.110, -0.980, -0.400, -0.110, 0.200, 0.040, 0.720, 0.710, 1.320, 0.370, 1.820, 0.770, 0.330, 1.070, 0.110, 1.030, 1.190, -1.410, 0.780, -0.590, 1.240, 2.170, -1.380, -1.470, 0.130, -0.520, 1.180, -1.480, -0.240, 0.810, 1.640, 1.440, -0.720, -1.980, -0.240, -0.250, 0.250, 0.750, -0.270, 0.040, 0.860, 0.300, 1.290, -0.480, 0.750, 0.540, 0.310, -0.220, 0.420, -0.740, -0.240, -1.460, 0.450, -1.190, -1.210, 1.670, 0.050, 0.190, 0.010, -1.000, -0.140, 0.540, -0.710, 1.740, 1.040, 0.960, 0.130, 1.320, -0.510, -0.960, -1.300, -0.040, 0.310, -0.150, -0.990, -0.340, 0.660, 1.410, 0.070, -0.230, 1.230, -0.130, 1.390, 2.000, -1.090, 0.700, 0.870, -0.860, 0.760, 1.770, -0.040, 2.200, -0.480, 0.120, -0.480, -0.490, 0.120, -0.610, -0.580, -1.460, -0.390, 0.610, 1.920, -0.230, -0.350, 1.230, 1.750, 0.250, -0.660, -0.980, -1.100, -0.070, -1.490, -0.210, -0.080, 0.870, 1.520, -1.920, 1.120, 0.300, 1.240, 0.110, -0.720, -0.680, 0.030, 1.750, 0.750, 0.370, -0.350, 0.820, -0.390, -2.140, -2.120, 0.670, -0.480, 0.280, 0.130, -0.270, -0.810, -1.650, -0.700, -1.190, 1.770, 0.140, -0.210, 0.030, 1.270, -2.460, -0.440, -1.080, 0.270, 0.300, -0.950, 2.150, -1.120, 1.000, -1.110, 1.010, -2.360, -1.110, -0.380, -0.760, -1.000, 1.490, -0.040, 0.680, 1.750, 0.060, -2.560, -0.210, -0.370, 0.990, 1.150, -0.650, 1.330, -0.440, 1.030, 0.440, 0.310, 0.330, -0.930, -0.900, -0.020, 0.710, -0.170, -0.280, -0.600, 1.650, 0.080, -0.020, -0.680, -1.160, -0.340, -0.140, 1.560, 1.840, -1.660, -2.060, 0.980, -0.250, 0.040, 0.000]);
    const grad = new jsnet.Tensor([2, 4, 2, 3], [-0.890, -0.580, -0.080, -0.040, -0.430, -0.960, -0.190, 0.380, -0.340, 0.370, 0.590, -0.400, 0.360, 1.000, 0.160, -0.390, 1.150, -0.680, 0.450, 0.710, 1.560, 0.020, -0.180, -2.330, -0.740, -0.240, -1.460, 0.450, -1.190, -1.210, 0.660, 1.410, 0.070, -0.230, 1.230, -0.130, -0.230, -0.350, 1.230, 1.750, 0.250, -0.660, -0.390, -2.140, -2.120, 0.670, -0.480, 0.280])

    const imageVar = new jsnet.Variable(image);
    const actualOut = jsnet.padImages(imageVar, 1, 4, 2, 3)
    assertClose(actualOut.value, padded);
    actualOut.backward(upstream);
    assertClose(imageVar.gradient, grad);
}

function testImagePatches() {
    const image = new jsnet.Tensor([2, 5, 8, 3], [-0.380, 0.190, 0.500, -1.290, 0.710, 1.710, 0.170, 1.050, -0.050, -0.120, 0.230, -0.160, 1.130, 0.850, -1.610, -0.560, 0.920, -0.780, -0.440, -0.270, 0.710, 0.910, -0.700, -0.880, 1.450, 0.500, 1.630, 0.550, 0.630, -0.960, -0.100, -1.670, 0.480, -0.620, -1.280, -0.370, -0.180, -0.040, 0.580, 1.280, 0.190, -1.870, -0.920, 0.190, 0.220, 2.040, 1.430, -0.300, -0.970, -0.280, 1.170, -0.270, 0.000, 0.020, 1.570, 0.850, -0.820, 0.260, 0.090, -0.640, -0.080, 0.520, -2.410, -0.240, 1.130, -0.190, 0.620, -2.020, -1.380, -0.750, 0.570, -0.760, 0.190, 0.550, -0.120, -0.040, 0.620, 0.200, -0.040, -0.550, 0.470, 1.610, 0.260, 0.450, 0.510, 0.290, -0.550, -0.580, -0.600, -0.850, -1.330, 1.160, 1.620, -2.260, -0.230, 1.280, -0.530, 0.850, 0.640, -0.880, -0.390, -0.170, 0.540, -1.260, -0.460, 0.490, -0.540, -0.220, 0.830, -0.380, 0.670, -0.200, 0.150, 0.990, 0.020, -0.620, -0.830, -0.790, -1.480, 0.350, 1.390, -0.760, -0.960, -1.160, 0.810, -0.350, 0.280, 0.630, 1.200, -0.650, 0.650, -2.770, 1.980, -0.110, -1.050, -0.210, 2.170, 0.250, 0.980, 0.180, -0.430, -0.250, 1.110, 0.990, -1.170, 0.000, -0.510, -0.230, 0.930, 0.550, -0.720, 0.470, 1.390, -0.320, 0.650, 0.250, -1.290, -0.470, 0.370, 0.500, 0.320, -0.150, 0.120, 1.390, -0.820, 1.150, -0.150, -0.660, -0.970, -0.490, 0.320, 0.610, -1.180, 1.290, 1.180, 0.650, -0.110, 1.230, 0.000, 1.060, -0.430, 0.980, 1.490, 1.670, -0.340, 1.190, -1.670, 0.770, -0.070, -0.390, 0.070, 0.440, -0.920, -0.840, 0.160, -1.040, -0.580, -0.150, -0.060, 1.800, 0.440, -0.050, 1.320, -2.650, 1.350, 0.730, 0.080, -0.120, -0.020, 1.120, -0.370, -0.130, -0.470, 2.070, 0.700, 1.720, 1.260, -0.300, -0.200, -1.680, -0.400, -0.390, -0.080, 0.140, 0.040, 0.150, -0.680, 0.820, -1.430, 1.210, -0.200, -1.600, 0.910, -0.210, -0.350, 0.200, -0.250, 0.970, 1.180, 0.050]);
    const patches = new jsnet.Tensor([2, 2, 3, 18], [-0.380, 0.190, 0.500, -1.290, 0.710, 1.710, 1.450, 0.500, 1.630, 0.550, 0.630, -0.960, -0.970, -0.280, 1.170, -0.270, 0.000, 0.020, -0.120, 0.230, -0.160, 1.130, 0.850, -1.610, -0.620, -1.280, -0.370, -0.180, -0.040, 0.580, 0.260, 0.090, -0.640, -0.080, 0.520, -2.410, -0.440, -0.270, 0.710, 0.910, -0.700, -0.880, -0.920, 0.190, 0.220, 2.040, 1.430, -0.300, 0.620, -2.020, -1.380, -0.750, 0.570, -0.760, -0.970, -0.280, 1.170, -0.270, 0.000, 0.020, 0.190, 0.550, -0.120, -0.040, 0.620, 0.200, -0.530, 0.850, 0.640, -0.880, -0.390, -0.170, 0.260, 0.090, -0.640, -0.080, 0.520, -2.410, 1.610, 0.260, 0.450, 0.510, 0.290, -0.550, 0.490, -0.540, -0.220, 0.830, -0.380, 0.670, 0.620, -2.020, -1.380, -0.750, 0.570, -0.760, -1.330, 1.160, 1.620, -2.260, -0.230, 1.280, 0.020, -0.620, -0.830, -0.790, -1.480, 0.350, 1.390, -0.760, -0.960, -1.160, 0.810, -0.350, -1.170, 0.000, -0.510, -0.230, 0.930, 0.550, -0.970, -0.490, 0.320, 0.610, -1.180, 1.290, -0.650, 0.650, -2.770, 1.980, -0.110, -1.050, -0.320, 0.650, 0.250, -1.290, -0.470, 0.370, 1.230, 0.000, 1.060, -0.430, 0.980, 1.490, 0.980, 0.180, -0.430, -0.250, 1.110, 0.990, 0.120, 1.390, -0.820, 1.150, -0.150, -0.660, -1.670, 0.770, -0.070, -0.390, 0.070, 0.440, -0.970, -0.490, 0.320, 0.610, -1.180, 1.290, -0.920, -0.840, 0.160, -1.040, -0.580, -0.150, 1.260, -0.300, -0.200, -1.680, -0.400, -0.390, 1.230, 0.000, 1.060, -0.430, 0.980, 1.490, -0.050, 1.320, -2.650, 1.350, 0.730, 0.080, 0.150, -0.680, 0.820, -1.430, 1.210, -0.200, -1.670, 0.770, -0.070, -0.390, 0.070, 0.440, -0.370, -0.130, -0.470, 2.070, 0.700, 1.720, -0.350, 0.200, -0.250, 0.970, 1.180, 0.050]);
    const upstream = new jsnet.Tensor([2, 2, 3, 18], [0.760, -0.300, -0.370, -0.420, -0.450, 0.420, 1.150, 0.960, -0.340, -1.050, 1.430, -1.410, -0.120, -1.160, 0.240, -0.990, -0.450, 1.780, -0.350, -1.230, 0.430, 0.690, -0.420, -0.240, 0.160, -0.440, -0.300, 0.120, -0.410, 1.230, -1.440, 0.160, 1.020, 0.190, 0.710, 0.530, -1.590, -0.760, -0.700, 0.270, 1.450, -1.330, -0.200, 1.450, -0.230, -0.480, 1.230, 1.190, 1.590, 0.820, 1.170, -0.300, 0.540, -0.840, -0.140, 1.230, -0.770, 0.460, 0.300, 0.060, -1.320, 0.580, -0.740, -0.580, -0.550, -0.540, -0.330, -0.900, 0.370, -1.310, 0.500, -0.500, -0.150, -0.610, 0.810, -1.790, 0.720, -1.400, -0.040, -0.810, -0.190, 0.190, -0.330, 0.320, 0.230, 1.720, -2.770, 0.920, 0.140, -0.320, -0.640, 0.300, -2.060, 0.190, 3.030, 0.380, 0.770, 0.520, -0.730, -1.450, -0.130, 0.500, 2.280, -1.190, 0.600, 1.190, 0.200, 0.020, 0.530, -0.870, 0.130, 0.860, -0.290, 2.090, -0.360, 0.460, 0.890, -0.040, -0.610, -0.820, 0.410, -1.050, 0.060, 0.510, -0.790, -1.140, 0.280, 0.980, 0.290, 1.550, -0.340, -1.090, 0.680, 0.570, 1.390, 1.120, 2.460, -1.280, 0.280, 0.180, -1.430, 0.320, -0.990, -1.100, -0.570, 0.260, -3.250, 1.730, -0.390, -1.190, -0.510, -1.640, 2.090, -0.880, 0.750, 0.550, 0.780, -0.920, -0.070, -0.450, 1.780, 2.870, 0.090, -0.190, 1.000, 2.170, 0.030, 0.370, 1.190, -0.150, 0.000, -0.620, 0.740, 0.990, -0.260, -1.800, 0.410, -0.670, -0.370, -0.310, 0.070, -1.650, -0.480, -0.670, 0.580, 0.270, 0.750, 0.330, 0.990, 1.410, 0.990, 0.010, -0.210, 0.420, -0.630, 0.310, 3.320, -1.240, 0.290, -0.320, 0.420, -0.840, -0.160, -0.590, 0.830, -1.040, 0.240, -0.360, -0.300, 0.300, -1.850, 1.110, -0.040, 1.670, 0.620, -0.450]);
    const grad = new jsnet.Tensor([2, 5, 8, 3], [0.760, -0.300, -0.370, -0.420, -0.450, 0.420, 0.000, 0.000, 0.000, -0.350, -1.230, 0.430, 0.690, -0.420, -0.240, 0.000, 0.000, 0.000, -1.590, -0.760, -0.700, 0.270, 1.450, -1.330, 1.150, 0.960, -0.340, -1.050, 1.430, -1.410, 0.000, 0.000, 0.000, 0.160, -0.440, -0.300, 0.120, -0.410, 1.230, 0.000, 0.000, 0.000, -0.200, 1.450, -0.230, -0.480, 1.230, 1.190, -0.260, 0.070, -0.530, -0.530, -0.150, 1.840, 0.000, 0.000, 0.000, -1.590, -0.450, 1.830, -1.600, 1.430, -0.870, 0.000, 0.000, 0.000, 0.950, 1.120, -0.890, -0.110, 3.570, -0.460, -1.320, 0.580, -0.740, -0.580, -0.550, -0.540, 0.000, 0.000, 0.000, -0.040, -0.810, -0.190, 0.190, -0.330, 0.320, 0.000, 0.000, 0.000, 0.770, 0.520, -0.730, -1.450, -0.130, 0.500, -0.330, -0.900, 0.370, -1.310, 0.500, -0.500, 0.000, 0.000, 0.000, 0.230, 1.720, -2.770, 0.920, 0.140, -0.320, 0.000, 0.000, 0.000, 2.280, -1.190, 0.600, 1.190, 0.200, 0.020, 0.530, -0.870, 0.130, 0.860, -0.290, 2.090, 0.000, 0.000, 0.000, 0.280, 0.980, 0.290, 1.550, -0.340, -1.090, 0.000, 0.000, 0.000, -0.570, 0.260, -3.250, 1.730, -0.390, -1.190, -0.360, 0.460, 0.890, -0.040, -0.610, -0.820, 0.000, 0.000, 0.000, 0.680, 0.570, 1.390, 1.120, 2.460, -1.280, 0.000, 0.000, 0.000, -0.510, -1.640, 2.090, -0.880, 0.750, 0.550, 0.500, -1.240, 1.060, 2.680, -0.760, -0.770, 0.000, 0.000, 0.000, 0.350, -1.470, -1.910, -0.350, -0.410, -0.830, 0.000, 0.000, 0.000, 1.070, -1.240, 0.350, -1.290, 1.620, 2.280, 1.190, -0.150, 0.000, -0.620, 0.740, 0.990, 0.000, 0.000, 0.000, 0.750, 0.330, 0.990, 1.410, 0.990, 0.010, 0.000, 0.000, 0.000, 0.830, -1.040, 0.240, -0.360, -0.300, 0.300, -0.260, -1.800, 0.410, -0.670, -0.370, -0.310, 0.000, 0.000, 0.000, -0.210, 0.420, -0.630, 0.310, 3.320, -1.240, 0.000, 0.000, 0.000, -1.850, 1.110, -0.040, 1.670, 0.620, -0.450]);


    const imageVar = new jsnet.Variable(image);
    const actualOut = jsnet.imagePatches(imageVar, 3, 2, 2, 3);
    assertClose(actualOut.value, patches.reshape([2, 2, 3, 3, 2, 3]));
    actualOut.backward(upstream.reshape([2, 2, 3, 3, 2, 3]));
    assertClose(imageVar.gradient, grad);
}

testPadImages();
testImagePatches();
console.log('PASS');
